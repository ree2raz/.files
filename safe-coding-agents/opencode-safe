#!/usr/bin/env bash
set -euo pipefail

PROJECT_DIR="${1:-$(pwd)}"

# Adjust these to every .env variant your repo has
ENV_FILES=(
  "$PROJECT_DIR/.env"
  "$PROJECT_DIR/.env.local"
  "$PROJECT_DIR/.env.production"
  "$PROJECT_DIR/backend/.env"
  "$PROJECT_DIR/frontend/.env"
)

# Build the --ro-bind /dev/null args for each env file
ENV_BLOCK=""
for f in "${ENV_FILES[@]}"; do
  ENV_BLOCK="$ENV_BLOCK --ro-bind /dev/null \"$f\""
done

CLEAN_PATH=$(echo "$PATH" | tr ':' '\n' | grep -v '^/mnt/' | tr '\n' ':' | sed 's/:$//')

eval bwrap \
  --ro-bind /usr /usr \
  --ro-bind /lib /lib \
  --ro-bind /lib64 /lib64 \
  --ro-bind /bin /bin \
  --ro-bind "$HOME/.local/bin/safe-shell" /bin/bash \
  --ro-bind "$HOME/.local/bin/safe-shell" /bin/sh \
  --ro-bind /etc/resolv.conf /etc/resolv.conf \
  --ro-bind /etc/hosts /etc/hosts \
  --ro-bind /etc/ssl /etc/ssl \
  --ro-bind /etc/passwd /etc/passwd \
  --ro-bind /etc/group /etc/group \
  --ro-bind /etc/nsswitch.conf /etc/nsswitch.conf \
  --ro-bind /etc/localtime /etc/localtime \
  --ro-bind /run /run \
  --ro-bind /sys /sys \
  --bind /dev/shm /dev/shm \
  --ro-bind "$HOME/.ssh" "$HOME/.ssh" \
  --ro-bind "$HOME/.gitconfig" "$HOME/.gitconfig" \
  --ro-bind "$HOME/.nvm" "$HOME/.nvm" \
  --bind "$HOME/.npm" "$HOME/.npm" \
  --ro-bind "$HOME/.cargo" "$HOME/.cargo" \
  --bind "$HOME/.cargo/registry" "$HOME/.cargo/registry" \
  --ro-bind "$HOME/.rustup" "$HOME/.rustup" \
  --ro-bind "$HOME/.local/bin/uv" "$HOME/.local/bin/uv" \
  --ro-bind "$HOME/.local/share/uv" "$HOME/.local/share/uv" \
  --ro-bind "$HOME/.cache/uv" "$HOME/.cache/uv" \
  --bind "$HOME/.opencode" "$HOME/.opencode" \
  --bind "$HOME/.config/opencode" "$HOME/.config/opencode" \
  --bind "$HOME/.local/share/opencode" "$HOME/.local/share/opencode" \
  --bind "$HOME/.local/state/opencode" "$HOME/.local/state/opencode" \
  --bind "$PROJECT_DIR" "$PROJECT_DIR" \
  --tmpfs /tmp \
  --proc /proc \
  --dev /dev \
  --share-net \
  --unshare-pid \
  --die-with-parent \
  --setenv PATH "$CLEAN_PATH" \
  --chdir "$PROJECT_DIR" \
  $ENV_BLOCK \
  "$HOME/.opencode/bin/opencode" .
